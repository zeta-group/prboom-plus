version: '2.5.1.7br{build}'


environment:
    matrix:
        - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
          MSVC_VER: 14 2015
        - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
          MSVC_VER: 15 2017

platform:
  - x64
 
configuration:
  - Debug
  - Release

before_build:
    # Install libraries
    - 'vcpkg install sdl2:%PLATFORM%-windows'
    - 'vcpkg install sdl2-net:%PLATFORM%-windows'
    - 'vcpkg install sdl2-mixer:%PLATFORM%-windows'
    - 'vcpkg install sdl2-image:%PLATFORM%-windows'
    - 'vcpkg install pcre:%PLATFORM%-windows'
    - 'vcpkg install zlib:%PLATFORM%-windows'
    - 'vcpkg install libvorbis:%PLATFORM%-windows'
    - 'vcpkg install fluidsynth:%PLATFORM%-windows'
    - 'vcpkg install portmidi:%PLATFORM%-windows'
    - 'vcpkg install opengl:%PLATFORM%-windows'
        
    # Setup CMake
    - 'cmake -G "Visual Studio %MSVC_VER% Win64" -S ./prboom2 "-DCMAKE_TOOLCHAIN_FILE=C:/tools/vcpkg/scripts/buildsystems/vcpkg.cmake" -DDEBUG_LIBNAME_SUFFIX=""'

after_build:
    # Package PRBoom+ output together
    - '7z a "prboom-plus-%APPVEYOR_BUILD_VERSION%.zip" "./%CONFIGURATION%/*.exe"'
    - '7z a "prboom-plus-%APPVEYOR_BUILD_VERSION%.zip" "./%CONFIGURATION%/*.wad"'
    - '7z a "prboom-plus-%APPVEYOR_BUILD_VERSION%.zip" "./%CONFIGURATION%/*.dll"'

artifacts:
    - path: prboom-plus-$(APPVEYOR_BUILD_VERSION).zip
      name: 'PRBoom+'
      type: Zip

build:
  project: $(APPVEYOR_BUILD_FOLDER)/PrBoom-Plus.sln

deploy:
    release: prboom-plus-win64-$(appveyor_build_version).zip
    description: '64-bit Windows build from AppVeyor.'
    provider: GitHub
    auth_token:
        secure: 8I+6+9VLJXaYWNCFmUJeF2oZazopqYMJxlmc07fbUXC207BpUdjhBZGI5G0gGWUM
    draft: false
    prerelease: false
    on:
        branch: appveyor
        APPVEYOR_REPO_TAG: true
    artifact: prboom-plus-$(APPVEYOR_BUILD_VERSION).zip

branches:
  only:
    - appveyor
